#!/usr/bin/env node

/**
 * Update Supabase Configuration Script
 * Updates all Supabase references with new project credentials
 */

const fs = require('fs');
const path = require('path');
const readline = require('readline');

const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  red: '\x1b[31m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m'
};

function log(message, color = colors.reset) {
  console.log(`${color}${message}${colors.reset}`);
}

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

function ask(question) {
  return new Promise(resolve => {
    rl.question(question, answer => resolve(answer.trim()));
  });
}

async function updateSupabaseConfig() {
  log('üîß Supabase Configuration Updater', colors.bright);
  log('==================================\n', colors.bright);

  log('Please provide your new Supabase project details:', colors.cyan);
  log('(You can find these in your Supabase Dashboard ‚Üí Settings ‚Üí API)\n', colors.blue);

  // Get new credentials from user
  const projectUrl = await ask('Enter your Supabase Project URL (e.g., https://abcdefghijk.supabase.co): ');
  const anonKey = await ask('Enter your Anon/Public Key: ');
  const serviceKey = await ask('Enter your Service Role Key (optional, press Enter to skip): ');

  // Extract project ID from URL
  const projectIdMatch = projectUrl.match(/https:\/\/([^.]+)\.supabase\.co/);
  if (!projectIdMatch) {
    log('\n‚ùå Invalid Supabase URL format!', colors.red);
    log('URL should be like: https://YOUR_PROJECT_ID.supabase.co', colors.yellow);
    rl.close();
    return;
  }

  const projectId = projectIdMatch[1];

  log('\nüìã Configuration to update:', colors.cyan);
  log(`  Project URL: ${projectUrl}`, colors.green);
  log(`  Project ID: ${projectId}`, colors.green);
  log(`  Anon Key: ${anonKey.slice(0, 20)}...${anonKey.slice(-10)}`, colors.green);
  if (serviceKey) {
    log(`  Service Key: ${serviceKey.slice(0, 20)}...${serviceKey.slice(-10)}`, colors.green);
  }

  const confirm = await ask('\nProceed with update? (y/n): ');
  if (confirm.toLowerCase() !== 'y') {
    log('Update cancelled.', colors.yellow);
    rl.close();
    return;
  }

  log('\nüöÄ Updating configuration files...', colors.cyan);

  // Update .env file
  try {
    const envPath = path.join(__dirname, '..', '.env');
    let envContent = '';

    if (fs.existsSync(envPath)) {
      envContent = fs.readFileSync(envPath, 'utf8');

      // Update existing values
      envContent = envContent.replace(/VITE_SUPABASE_URL=.*/g, `VITE_SUPABASE_URL=${projectUrl}`);
      envContent = envContent.replace(/VITE_SUPABASE_ANON_KEY=.*/g, `VITE_SUPABASE_ANON_KEY=${anonKey}`);

      if (serviceKey) {
        if (envContent.includes('SUPABASE_SERVICE_ROLE_KEY=')) {
          envContent = envContent.replace(/SUPABASE_SERVICE_ROLE_KEY=.*/g, `SUPABASE_SERVICE_ROLE_KEY=${serviceKey}`);
        } else {
          envContent += `\nSUPABASE_SERVICE_ROLE_KEY=${serviceKey}`;
        }
      }
    } else {
      // Create new .env file
      envContent = `# Supabase Configuration
VITE_SUPABASE_URL=${projectUrl}
VITE_SUPABASE_ANON_KEY=${anonKey}`;
      if (serviceKey) {
        envContent += `\nSUPABASE_SERVICE_ROLE_KEY=${serviceKey}`;
      }
    }

    fs.writeFileSync(envPath, envContent);
    log('  ‚úÖ Updated .env file', colors.green);
  } catch (error) {
    log(`  ‚ùå Failed to update .env: ${error.message}`, colors.red);
  }

  // Update src/utils/supabase/info.tsx
  try {
    const infoPath = path.join(__dirname, '..', 'src', 'utils', 'supabase', 'info.tsx');
    const infoContent = `/* AUTOGENERATED FILE - DO NOT EDIT CONTENTS */

export const projectId = "${projectId}"
export const publicAnonKey = "${anonKey}"
`;

    fs.writeFileSync(infoPath, infoContent);
    log('  ‚úÖ Updated src/utils/supabase/info.tsx', colors.green);
  } catch (error) {
    log(`  ‚ùå Failed to update info.tsx: ${error.message}`, colors.red);
  }

  log('\nüìù Next Steps:', colors.bright);
  log('\n1. Test locally:', colors.cyan);
  log('   npm run dev', colors.blue);
  log('   # Open http://localhost:3000 and test authentication', colors.blue);

  log('\n2. Set Vercel environment variables:', colors.cyan);
  log('   vercel env add VITE_SUPABASE_URL production', colors.blue);
  log('   # Enter: ' + projectUrl, colors.yellow);
  log('   vercel env add VITE_SUPABASE_ANON_KEY production', colors.blue);
  log('   # Enter: ' + anonKey.slice(0, 20) + '...', colors.yellow);
  if (serviceKey) {
    log('   vercel env add SUPABASE_SERVICE_ROLE_KEY production', colors.blue);
    log('   # Enter: ' + serviceKey.slice(0, 20) + '...', colors.yellow);
  }

  log('\n3. Deploy to production:', colors.cyan);
  log('   vercel deploy --prod', colors.blue);

  log('\n4. Verify the fix:', colors.cyan);
  log('   node scripts/check-supabase.js', colors.blue);

  log('\n‚ú® Configuration updated successfully!', colors.green);
  log('\n‚ö†Ô∏è  IMPORTANT:', colors.yellow);
  log('- Clear your browser cache or use incognito mode', colors.yellow);
  log('- The old project ID might be cached', colors.yellow);
  log('- Make sure to deploy to Vercel after testing locally', colors.yellow);

  rl.close();
}

// Run the updater
updateSupabaseConfig().catch(error => {
  log(`\n‚ùå Error: ${error.message}`, colors.red);
  rl.close();
  process.exit(1);
});